<#
.SYNOPSIS
Returns GitHub repos that are reporting vulnerabilities from a single GitHub organisation

.DESCRIPTION
Returns GitHub repos matching a search pattern that are reporting vulnerabilities from a single GitHub organisation

.PARAMETER GitHubOrg
The name of the GitHub organisation

.PARAMETER RepoSearchString
A search pattern for the repos to query

.EXAMPLE
Set-GitHubSessionInformation -PatToken <not-a-real-pat-token>
Get-GitHubVulnerability -GitHubOrg MyGitHubOrg -RepoSearchString MyRepo
#>
function Get-GitHubVulnerability {
    [Diagnostics.CodeAnalysis.SuppressMessageAttribute("PSReviewUnusedParameter", "RepoSearchString", Justification = "False positive as rule does not know that Where-Object operates within the same scope")]
    [CmdletBinding()]
    param(
        [string]$GitHubOrg,
        [string]$RepoSearchString
    )

    $Baseurl = "https://api.github.com/graphql"
    $SessionInfo = Get-GitHubSessionInformation

    $HasNextPage = $true
    $PageInfo = ""
    $repositories = @()

    while ($HasNextPage) {
        $query = @"
{
    "query": "query { organization(login:\"$GitHubOrg\") { name repositories(first:100$PageInfo){ totalCount pageInfo { endCursor hasNextPage } edges { node { name vulnerabilityAlerts(first:40){ edges { node { securityVulnerability { vulnerableVersionRange  package { name } }  } } }  } } } }  }"
}
"@
        $response = Invoke-RestMethod -Method Post -Uri "$($Baseurl)" -Body $query -Headers $SessionInfo.Headers

        $HasNextPage = $response.data.organization.repositories.pageInfo.hasNextPage -eq "True"
        $PageInfo = ", after:\""$($response.data.organization.repositories.pageInfo.endCursor)\"""
        $repositories += $response.data.organization.repositories.edges
    }

    $VulnerableRepos = $repositories | Where-Object { $_.node.name -like $RepoSearchString -and $_.node.vulnerabilityAlerts.edges.Length -gt 0 }

    ($VulnerableRepos | ForEach-Object {
        return @{
            name = $_.node.name
            alerts = $_.node.vulnerabilityAlerts.edges | ForEach-Object {
                return $_.node.securityVulnerability
            }
        }
    }) | ConvertTo-Json -Depth 10
}
