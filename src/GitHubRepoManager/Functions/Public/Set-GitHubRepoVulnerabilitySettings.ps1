<#
.SYNOPSIS
    A PowerShell function for enabling vulnerability alerts and automated security fixes.
.DESCRIPTION
    A PowerShell function for enabling vulnerability alerts and automated security fixes.
.PARAMETER GitHubOrg
    The name of the GitHub organisation
.PARAMETER RepoSearchString
    A search pattern for the repos to query.  The like comparison operator is used to match repos names so suffix any partial patterns with *
.EXAMPLE
    Set-GitHubSessionInformation -PatToken <not-a-real-pat-token>
    Set-GitHubAutomatedSecurityFixes -GitHubOrg MyGitHubOrg -RepoSearchString MyRepo
.NOTES
    Uses:
    https://docs.github.com/en/rest/reference/repos#enable-vulnerability-alerts
    https://docs.github.com/en/rest/reference/repos#enable-automated-security-fixes
    Vulnerbility alerts must be enabled before enabling automated security fixes
#>
function Set-GitHubRepoVulnerabilitySettings {
    Param (
        [String]$GitHubOrg,
        [String]$RepoSearchString
    )

    $Uri = "/orgs/$GitHubOrg/repos?type=all"
    $Repos = Invoke-GitHubRestMethod -Method GET -Uri $uri
    Write-Verbose -Message "Got $($Repos.Length) repositories"

    $MatchedRepos = $Repos | Where-Object {$_.name -like $RepoSearchString -and $_.archived -eq $false}

    foreach ($Repo in $MatchedRepos) {
        Write-Verbose -Message "Enabling vulnerability alerts for $($Repo.name)"
        $Uri = "/repos/$GitHubOrg/$($Repo.name)/vulnerability-alerts"
        Invoke-GitHubRestMethod -Method PUT -Uri $Uri
        Write-Verbose -Message "Enabling automated security fixes for $($Repo.name)"
        $Uri = "/repos/$GitHubOrg/$($Repo.name)/automated-security-fixes"
        Invoke-GitHubRestMethod -Method PUT -Uri $Uri
    }
}
