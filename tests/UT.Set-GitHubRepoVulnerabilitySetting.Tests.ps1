Import-Module $PSScriptRoot\..\src\GitHubToolKit.psm1 -Force

Describe "Set-GitHubRepoVulnerabilitySetting tests" -Tags @("Unit") {
    Mock Get-GitHubRepo -ModuleName GitHubToolKit -MockWith {
        return @(
            @{
                name = "foo-bar-repo"
                isArchived = $false
                isPrivate = $true
            },
            @{
                name = "foo-foo-repo"
                isArchived = $false
                isPrivate = $true
            }
        )
    }
    Mock Invoke-GitHubRestMethod -ModuleName GitHubToolKit -ParameterFilter { $Uri -match "\/repos\/FooBarAgency\/foo-.*" } -MockWith {
        return $null
    }
    Context "All mandatory parameters are passed" {
        It "Should not throw and 6 calls of Invoke-GitHubRestMethod for the two repositories" {
            Set-GitHubSessionInformation -PatToken "not-a-real-pat-token"
            { Set-GitHubRepoVulnerabilitySetting -GitHubOrg "FooBarAgency" -RepoPrefix "foo-" } | Should not throw
            Assert-MockCalled -CommandName Invoke-GitHubRestMethod -ModuleName GitHubToolKit -Times 6 -Exactly
        }
    }
    Context "All mandatory parameters and optional ExcludedRepoPrefix parameter passed" {
        It "Should not throw, no repositories matched after exclusion with ExcludedRepoPrefix parameter resulting in 0 calls of Invoke-GitHubRestMethod" {
            Set-GitHubSessionInformation -PatToken "not-a-real-pat-token"
            { Set-GitHubRepoVulnerabilitySetting -GitHubOrg "FooBarAgency" -RepoPrefix "f" -ExcludedRepoPrefix "foo" } | Should not throw
            Assert-MockCalled -CommandName Invoke-GitHubRestMethod -ModuleName GitHubToolKit -Times 0 -Exactly
        }
    }
}
